<!DOCTYPE html>
<html>

<head>
    <title>Rock, Paper, Scissors</title>
    <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
    <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

</head>

<body>
    <div class="container">
        <h2>Players</h2>
            <ul id="playersActive">
                <li>examplePlayer</li>        
            </ul>
    </div>
    <div>
        <button type="button" id="startButton">Start Game</button>
    </div>
    <div class="gameContainer">
        <img src="images/rock.jpg" id="rock" class="gameButtons">
        <img src="images/paper.jpg" id="paper" class="gameButtons">
        <img src="images/scissors.jpg" id="scissors" class="gameButtons">
    </div>
    
    
    <!--PSEUDOCODE I need the user to make a choice
Computer to make a choice
Capture those choices
Compare these choices, and determine a win, or tie
Display the result of the user
 -->
    <div>App is working</div>
    
<script>
  // Initialize Firebase
  // GLOBAL VARIABLES
    var startButton = $("#startButton");
    var gameButtons = $(".gameButtons");
    var rock = $("#rock");
    var paper = $("#paper");
    var scissors = $("#scissors"); 
    var playersActive = $("#playersActive"); 
    var config = {
    apiKey: "AIzaSyB0Tfvw3j1vHHZ3Hh9qds3pgi6wo4nWq_Y",
    authDomain: "rps-multiplayer-97299.firebaseapp.com",
    databaseURL: "https://rps-multiplayer-97299.firebaseio.com",
    projectId: "rps-multiplayer-97299",
    storageBucket: "",
    messagingSenderId: "427506108273"
  };
  // FUNCTIONS
    function sendDataToDatabase(ref, data) {
            //ref sends user data to Google
            ref.update(data);
    };
    function startGame(game, userID){
        console.log("starting the app");
        var newBtn = $("#startButton");
        var gameBtns = $(".gameButtons");
        
        gameBtns.on("click", function(e){
            sendDataToDatabase(firebase.database().ref("players/"+userID), { gameChoice: e.target.id })
        });
        newBtn.show();
        newBtn.on("click", function(){
            console.log("working");
            gameBtns.show();
            /* wait for user opponent */
            console.log(game);
            firebase.database().ref("players/"+userID).on('child_changed', function(snapshot){
                console.log(snapshot.val());
            })
            firebase.database().ref("gameRoom/"+game.id).on("value", function(e){
              var allUsers = e.val();
                console.log(allUsers);
                /* conditions */
              if(allUsers !== null){
                  var iDS = Object.keys(allUsers);
                  console.log(iDS);
                  if(iDS.length == 1){
                     if(iDS[0] === userID){
                         console.log('waiting for a player to arrive');
                     }
                  }
                  else if(iDS.length == 2){
                     console.log('player has arrived');
                      console.log(iDS);
                      var filterOpponent = iDS.filter(function(each){ return each != userID });
                      firebase.database().ref("gameRoom/"+filterOpponent[0]).on("value", function(snapshot){
                          console.log(snapshot.val());
                      });
                  }  
              } else {
                  console.log('game is going');
                  
              }
            });
        });
        
    }
    function findOpenGame(userID, player, ref, gameKey, game){
        firebase.database().ref("gameRoom").once("value", function(e){
            var newVal = e.val();
            if(newVal !== null){
                // if its not empty
                console.log('is not empty');
                console.log('check Open games');
                console.log(newVal);
                var allKeys = Object.keys(newVal);
                allKeys.forEach(function(each){
                    var newGameRoom = newVal[each];
                    var users = Object.keys(newGameRoom);
                    if(users.length < 2){
                        if(users[0] !== userID){
                             console.log('attach to current game');
                             sendDataToDatabase(firebase.database().ref("gameRoom/"+each), player);
                             sendDataToDatabase(firebase.database().ref("players/"+userID), { currentGameRoom: each });
                             /* this will initialize the settings for the game */
                             startGame(game, userID);
                        } else{
                            console.log('already in game');
                        }
                    } else {
                        console.log('game is full');
                        sendDataToDatabase(ref, player);
                        sendDataToDatabase(firebase.database().ref("players/"+userID), { currentGameRoom: gameKey });
                    }
                })
                
            } else {
                /* creating new player and new game */
                sendDataToDatabase(ref, player);
                sendDataToDatabase(firebase.database().ref("players/"+userID), { currentGameRoom: gameKey });
                startGame(game, userID);
            }
        });
    };
    function createPlayerList(player, parent) {
        var list = document.createElement("li");
        var text = document.createTextNode(player);
        list.appendChild(text);
        parent.append(list);
    };
  firebase.initializeApp(config);
  firebase.auth().signInAnonymously().catch(function(error){
      console.log(error.message);
  });
  firebase.auth().onAuthStateChanged(function(user){
       var playerRef = firebase.database().ref("players");
       var singleUserRef = firebase.database().ref("players/"+user.uid);
       var gameRoomRef = firebase.database().ref("gameRoom").push();
       var gameRoomKey = gameRoomRef.key;
       var player = { [user.uid] : "online" };
       var game = {
        id: gameRoomKey,
       };
      if(user) {
        playerRef.on("value", function(newValue) {
            var database = newValue.val();
           //var newKeys = Object.keys(database);
            
        });
        singleUserRef.once("value", function(e){
            var currentUserInfo = e.val();
            console.log(currentUserInfo);
            if(currentUserInfo){
                var newGameKey = firebase.database().ref('gameRoom/'+currentUserInfo.currentGameRoom).key;
                if(newGameKey !== "none"){
                    console.log('user is currently in game room' + newGameKey);
                } else {
                    findOpenGame(user.uid,player, gameRoomRef, gameRoomKey);
                }
            } else {
               console.log('no current user info has been pushed!');
               var newUser = {}; 
               newUser[user.uid]= { userName: "player" + user.uid, currentGameRoom: "none", isPlaying: false };
               sendDataToDatabase(playerRef, newUser);
                //set player in a game room or create one
               /* adds player to the game room */
                
                findOpenGame(user.uid,player, gameRoomRef, gameRoomKey, game);
            }
        })
    }  
  });
</script>
</body>
<style>
    #startButton{
        display: none;
    }
    .gameButtons{
        display: none;
    }
</style>
</html>